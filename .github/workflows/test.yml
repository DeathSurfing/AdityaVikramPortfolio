name: ğŸ§ª Test Portfolio

permissions:
  contents: read

on:
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  test-frontend:
    name: ğŸŸ¢ Test Frontend
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ğŸ“¦ Install dependencies
        run: |
          cd frontend
          npm ci

      - name: ğŸ” Lint code
        run: |
          cd frontend
          npm run lint

      - name: ğŸ—ï¸ Test build
        run: |
          cd frontend
          npm run build

      - name: ğŸ“Š Build summary
        run: |
          echo "âœ… Frontend tests passed!"
          cd frontend
          echo "ğŸ“¦ Build size:"
          du -sh .next 2>/dev/null || echo "No .next directory found"
          echo ""
          echo "ğŸ“‹ Build output:"
          ls -la .next/ 2>/dev/null || echo "No .next directory found"

  test-backend:
    name: ğŸ Test Backend
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install dependencies
        run: |
          cd ollama-proxy
          pip install -r requirements.txt

      - name: ğŸ” Lint Python code
        run: |
          cd ollama-proxy
          python -m flake8 main.py --max-line-length=120 --ignore=E501,W503

      - name: âœ… Backend summary
        run: |
          echo "âœ… Backend tests passed!"
          echo "ğŸ Python version: $(python --version)"
          echo "ğŸ“¦ Installed packages:"
          cd ollama-proxy && pip list | grep -E "(fastapi|uvicorn|requests)" || echo "Core packages installed"

  test-docker:
    name: ğŸ³ Test Docker Build
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'  # Only run on manual trigger
    
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ³ Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ğŸ—ï¸ Test Frontend Docker build
        run: |
          cd frontend
          docker build -t test-frontend .
          echo "âœ… Frontend Docker image built successfully"

      - name: ğŸ—ï¸ Test Proxy Docker build
        run: |
          cd ollama-proxy
          docker build -t test-proxy .
          echo "âœ… Proxy Docker image built successfully"

      - name: ğŸ“Š Docker summary
        run: |
          echo "âœ… All Docker builds successful!"
          echo "ğŸ“¦ Images built:"
          docker images | grep test- | head -5

  summary:
    name: ğŸ“‹ Test Summary
    runs-on: ubuntu-latest
    needs: [test-frontend, test-backend]
    if: always()
    
    steps:
      - name: âœ… Success summary
        if: needs.test-frontend.result == 'success' && needs.test-backend.result == 'success'
        run: |
          echo "ğŸ‰ All tests passed!"
          echo "âœ… Frontend: Build and lint successful"
          echo "âœ… Backend: Lint successful"
          echo ""
          echo "ğŸš€ Ready for deployment!"

      - name: âŒ Failure summary
        if: needs.test-frontend.result == 'failure' || needs.test-backend.result == 'failure'
        run: |
          echo "âŒ Some tests failed!"
          echo "Frontend: ${{ needs.test-frontend.result }}"
          echo "Backend: ${{ needs.test-backend.result }}"
          echo ""
          echo "ğŸ” Please check the logs above for details"
          exit 1
