name: ğŸš€ Deploy Portfolio

permissions:
  contents: read

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
        - local
      force_rebuild:
        description: 'Force rebuild Docker images'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  # ==============================================================================
  # TEST & LINT PHASE (GitHub-hosted runners)
  # ==============================================================================
  test:
    name: ğŸ§ª Test & Lint
    runs-on: ubuntu-latest
    outputs:
      should_deploy: ${{ steps.check_deploy.outputs.should_deploy }}
    
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: ğŸ“¦ Install frontend dependencies
        run: |
          cd frontend
          npm ci

      - name: ğŸ” Lint frontend
        run: |
          cd frontend
          npm run lint

      - name: ğŸ—ï¸ Test frontend build
        run: |
          cd frontend
          npm run build

      - name: ğŸ Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: ğŸ“¦ Install Python dependencies
        run: |
          cd ollama-proxy
          pip install -r requirements.txt

      - name: ğŸ” Lint Python code
        run: |
          cd ollama-proxy
          python -m flake8 main.py --max-line-length=120 --ignore=E501,W503 || true

      - name: âœ… Tests passed
        run: |
          echo "âœ… All tests and linting passed!"
          echo "Frontend build size:"
          cd frontend && du -sh .next || echo "No .next directory found"

      - name: ğŸ” Check if deployment should proceed
        id: check_deploy
        run: |
          # Deploy on main branch push or manual workflow dispatch
          if [[ "${{ github.ref }}" == "refs/heads/main" && "${{ github.event_name }}" == "push" ]] || 
             [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "âœ… Deployment conditions met"
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ Skipping deployment (not main branch or manual trigger)"
          fi

  # ==============================================================================
  # BUILD PHASE (Self-hosted or production server)
  # ==============================================================================
  build:
    name: ğŸ³ Build Docker Images
    runs-on: self-hosted
    needs: test
    if: needs.test.outputs.should_deploy == 'true'
    
    steps:
      - name: ğŸ“¦ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ” Check Docker availability
        run: |
          if ! command -v docker &> /dev/null; then
            echo "âŒ Docker is not available on this runner"
            exit 1
          fi
          docker --version

      - name: ğŸ³ Set up Docker Buildx (optional)
        run: |
          if command -v docker-buildx &> /dev/null; then
            echo "âœ… Docker Buildx available"
            docker buildx version
          else
            echo "â„¹ï¸ Docker Buildx not available, using regular Docker build"
          fi

      - name: ğŸ§¹ Clean up old images (if force rebuild)
        if: github.event.inputs.force_rebuild == 'true'
        run: |
          echo "ğŸ§¹ Force rebuild requested - cleaning up old images..."
          docker rmi portfolio-frontend:latest portfolio-proxy:latest 2>/dev/null || true
          docker image prune -f || true

      - name: ğŸ—ï¸ Build Frontend image
        run: |
          echo "ğŸ—ï¸ Building Frontend Docker image..."
          cd frontend
          docker build \
            -t portfolio-frontend:latest \
            -t portfolio-frontend:${{ github.sha }} \
            -t portfolio-frontend:$(date +%Y%m%d-%H%M%S) \
            .

      - name: ğŸ—ï¸ Build Proxy image
        run: |
          echo "ğŸ—ï¸ Building Proxy Docker image..."
          cd ollama-proxy
          docker build \
            -t portfolio-proxy:latest \
            -t portfolio-proxy:${{ github.sha }} \
            -t portfolio-proxy:$(date +%Y%m%d-%H%M%S) \
            .

      - name: ğŸ“‹ Show built images
        run: |
          echo "âœ… Successfully built images:"
          echo ""
          docker images | head -n1  # Header
          docker images | grep portfolio | head -10  # Show latest portfolio images
          echo ""
          
          # Show image sizes
          echo "ğŸ“Š Image sizes:"
          docker images --format "table {{.Repository}}\t{{.Tag}}\t{{.Size}}" | grep portfolio

      - name: ğŸ§¹ Clean up dangling images
        run: |
          echo "ğŸ§¹ Cleaning up dangling images..."
          docker image prune -f || true
          
          # Optional: Clean up old tagged images (keep latest + last 5)
          echo "ğŸ§¹ Cleaning up old tagged images (keeping latest + last 5)..."
          
          # Clean old frontend images
          OLD_FRONTEND=$(docker images portfolio-frontend --format "{{.Tag}}" | grep -v latest | tail -n +6)
          for tag in $OLD_FRONTEND; do
            echo "Removing old image: portfolio-frontend:$tag"
            docker rmi portfolio-frontend:$tag || true
          done
          
          # Clean old proxy images
          OLD_PROXY=$(docker images portfolio-proxy --format "{{.Tag}}" | grep -v latest | tail -n +6)
          for tag in $OLD_PROXY; do
            echo "Removing old image: portfolio-proxy:$tag"
            docker rmi portfolio-proxy:$tag || true
          done

  # ==============================================================================
  # DEPLOYMENT PHASE
  # ==============================================================================
  deploy:
    name: ğŸš€ Deploy Services
    runs-on: self-hosted
    needs: [test, build]
    if: needs.test.outputs.should_deploy == 'true'
    environment:
      name: ${{ github.event.inputs.environment || 'production' }}
      url: http://localhost:3000
    
    steps:
      - name: ğŸ”„ Stop existing services
        run: |
          echo "ğŸ”„ Stopping existing services..."
          if [ -f docker-compose.yml ]; then
            docker-compose down --timeout 30 || true
          else
            echo "â„¹ï¸ No docker-compose.yml found, skipping stop"
          fi

      - name: ğŸš€ Start new services
        run: |
          echo "ğŸš€ Starting services with new images..."
          docker-compose up -d
          
          # Show started containers
          echo ""
          echo "ğŸ“Š Started containers:"
          docker-compose ps

      - name: â³ Wait for services to initialize
        run: |
          echo "â³ Waiting for services to initialize..."
          sleep 30
          
          # Show container status
          echo "ğŸ“Š Container status after 30 seconds:"
          docker-compose ps

      - name: ğŸ” Health checks
        run: |
          echo "ğŸ” Performing health checks..."
          
          # Function to check service health
          check_service() {
            local service_name="$1"
            local url="$2"
            local max_attempts=5
            local attempt=1
            
            while [ $attempt -le $max_attempts ]; do
              echo "Attempt $attempt/$max_attempts - Checking $service_name..."
              
              if curl -f "$url" > /dev/null 2>&1; then
                echo "âœ… $service_name is healthy"
                return 0
              else
                echo "âš ï¸ $service_name not ready yet, waiting..."
                sleep 10
                ((attempt++))
              fi
            done
            
            echo "âŒ $service_name health check failed after $max_attempts attempts"
            return 1
          }
          
          # Check services
          FRONTEND_HEALTHY=0
          PROXY_HEALTHY=0
          
          check_service "Frontend" "http://localhost:3000" && FRONTEND_HEALTHY=1
          check_service "Proxy" "http://localhost:5950/health" && PROXY_HEALTHY=1
          
          # Summary
          echo ""
          echo "ğŸ¥ Health Check Summary:"
          [ $FRONTEND_HEALTHY -eq 1 ] && echo "âœ… Frontend: Healthy" || echo "âŒ Frontend: Unhealthy"
          [ $PROXY_HEALTHY -eq 1 ] && echo "âœ… Proxy: Healthy" || echo "âŒ Proxy: Unhealthy"
          
          # Show logs if any service is unhealthy
          if [ $FRONTEND_HEALTHY -eq 0 ]; then
            echo ""
            echo "ğŸ” Frontend logs:"
            docker-compose logs --tail=20 frontend || true
          fi
          
          if [ $PROXY_HEALTHY -eq 0 ]; then
            echo ""
            echo "ğŸ” Proxy logs:"
            docker-compose logs --tail=20 ollama-proxy || true
          fi
          
          # Exit with error if critical services are unhealthy
          if [ $FRONTEND_HEALTHY -eq 0 ]; then
            echo "âŒ Deployment failed - Frontend is not healthy"
            exit 1
          fi

      - name: ğŸ“Š Deployment summary
        run: |
          echo "ğŸ‰ Deployment completed successfully!"
          echo ""
          echo "ğŸ“‹ Deployment Summary:"
          echo "======================"
          echo "ğŸ”— Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Deployed by: ${{ github.actor }}"
          echo "ğŸ• Time: $(date)"
          echo "ğŸŒ Environment: ${{ github.event.inputs.environment || 'production' }}"
          echo ""
          echo "ğŸŒ Services:"
          echo "- Frontend: http://localhost:3000"
          echo "- Proxy API: http://localhost:5950"
          echo "- Health Check: http://localhost:5950/health"
          echo ""
          echo "ğŸ“Š Running containers:"
          docker-compose ps
          echo ""
          echo "ğŸ’¾ Docker images:"
          docker images | grep portfolio | head -5

  # ==============================================================================
  # NOTIFICATION PHASE
  # ==============================================================================
  notify:
    name: ğŸ“¢ Notify Result
    runs-on: self-hosted
    needs: [test, build, deploy]
    if: always() && needs.test.outputs.should_deploy == 'true'
    
    steps:
      - name: ğŸ‰ Success notification
        if: needs.deploy.result == 'success'
        run: |
          echo "ğŸ‰ Portfolio deployment successful!"
          echo "âœ… All services are running and healthy"
          echo "ğŸ”— Frontend: http://localhost:3000"
          echo "ğŸ“Š Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ By: ${{ github.actor }}"

      - name: âŒ Failure notification
        if: needs.deploy.result == 'failure'
        run: |
          echo "âŒ Portfolio deployment failed!"
          echo "ğŸ” Check the logs above for details"
          echo "ğŸ”— Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ By: ${{ github.actor }}"
          echo ""
          echo "ğŸ› ï¸ Troubleshooting tips:"
          echo "- Check container logs: docker-compose logs"
          echo "- Verify images exist: docker images | grep portfolio"
          echo "- Check service status: docker-compose ps"
